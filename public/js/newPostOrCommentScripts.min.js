$(function(){var t=document.getElementById("editor");t&&attachQuill(t),$("body").on("focus",".ql-editor",function(t){"editor"==t.target.parentElement.id&&$(t.target.parentElement).siblings(".post-controls").css("display","flex"),$(this).closest(".editable-text").addClass("focused")}),$("body").on("focusout",".ql-editor",function(t){$(this).closest(".editable-text").removeClass("focused")}),$("body").on("click","#postContentWarningsButton",function(){var t=$(this).closest(".contentForm").find("#postContentWarningsContainer");t.removeClass("bounce"),t.is(":hidden")?t.slideDown("fast"):t.is(":visible")&&!t.find("#postContentWarnings").val()?t.slideUp("fast"):t.addClass("bounce")}),$("body").on("change","#postPrivacy-private, #editPostPrivacy-private",function(){if(this.checked){var t=$(this).closest(".contentForm");$(window).width()>350?t.find("#privatePrivacyLabel").html("<i class='fas fa-eye-slash'></i> Private"):t.find("#privatePrivacyLabel").html("<i class='fas fa-eye-slash'></i>"),t.find("#publicPrivacyLabel").html("<i class='fas fa-eye'></i>"),t.find("#draftLabel").html("<i class='fas fa-pencil-ruler'></i>"),t.find("#postSubmit").html("Send <i class='fas fa-chevron-right'></i>").removeClass("save-draft-button")}}),$("body").on("change","#postPrivacy-public, #editPostPrivacy-public",function(){if(this.checked){var t=$(this).closest(".contentForm");$(window).width()>350?t.find("#publicPrivacyLabel").html("<i class='fas fa-eye'></i> Public"):t.find("#publicPrivacyLabel").html("<i class='fas fa-eye'></i>"),t.find("#privatePrivacyLabel").html("<i class='fas fa-eye-slash'></i>"),t.find("#draftLabel").html("<i class='fas fa-pencil-ruler'></i>"),t.find("#postSubmit").html("Send <i class='fas fa-chevron-right'></i>").removeClass("save-draft-button")}}),$("body").on("change","#pseudoPrivacy-draft, #editPseudoPrivacy-draft",function(){if(this.checked){var t=$(this).closest(".contentForm");$(window).width()>350?t.find("#draftLabel").html("<i class='fas fa-pencil-ruler'></i> Draft"):t.find("#draftLabel").html("<i class='fas fa-pencil-ruler'></i>"),t.find("#privatePrivacyLabel").html("<i class='fas fa-eye-slash'></i>"),t.find("#publicPrivacyLabel").html("<i class='fas fa-eye'></i>"),t.find("#postSubmit").html("Save <i class='fas fa-chevron-right'></i>").addClass("save-draft-button")}}),$("body").on("click",".show-emoji-picker",function(){var t=$(this).closest(".contentForm, .new-comment-form");t.find(".emoji-picker").slideToggle("fast"),t.find(".ql-editor").focus()}),$("body").on("click",".replyEmojiWindowButton",function(){emojiPicker=$(this).closest(".new-comment-form").find(".emoji-picker"),t=$(this).closest(".new-comment-form").find(".ql-editor"),emojiPicker.slideToggle("fast"),t.focus()}),$("body").on("click",".emoji-picker>.add-emoji",function(){var t=$(this).closest(".contentForm, .new-comment-form");t.find(".ql-container")[0].insertEmojiAtCursor(event.target.innerHTML)}),$("body").on("click",".edit-post",function(){var t=$(this);t.html('<i class="fas fa-spinner fa-spin"></i>');var e=$("#editPostModal"),i=t.closest(".post"),o=i.attr("data-post-id");e.length&&e.attr("data-post-id")==o?(e.modal(),t.hasClass("edit-draft-post")?t.html('<i class="fas fa-fw fa-pencil-alt"></i>'):t.html('<i class="fas fa-fw fa-pencil-alt"></i> Edit')):(e.length&&e.remove(),$.post("/createposteditor/"+o,function(e){$("body").append(e.editor);var o=$("#editPostModal");attachQuill(o.find("#editPostContent")[0]);var a=o.find(".ql-editor");tribute&&tribute.attach(a),a.empty(),a.append(e.content),a.find(".image-move").each(function(t,e){e.addEventListener("touchstart",touchStartOnHandle,{passive:!1})}),a.find(".image-move").on("mousedown",mousedownOnHandle),a.find(".image-clear").click(clearEmbed),createImageGroups(a),o[0].postContainer=i[0],t.hasClass("edit-draft-post")?t.html('<i class="fas fa-fw fa-pencil-alt"></i>'):t.html('<i class="fas fa-fw fa-pencil-alt"></i> Edit'),o.modal()}))}),$("body").on("click","#editPostSubmit",function(t){t.preventDefault();var e=$(this),i=e.closest(".modal-content"),o=i.find(".ql-container")[0];if(o.hasContent()){e.attr("disabled",!0),e.html('<i class="fas fa-spinner fa-spin"></i> Sending...');var a=o.getContents(),n=$("#editPostModal"),s=$(n[0].postContainer),d=n.attr("data-post-id"),l=i.find("#postContentWarnings").val().trim(),r=n.attr("data-original-privacy"),c=$("#editPostPrivacy-public").is(":checked")||n.attr("data-is-community")?"public":"private",f=n.attr("data-is-draft"),m=$("#editPseudoPrivacy-draft").is(":checked");$.post("/saveedits/"+d,{postContent:JSON.stringify(a),postContentWarnings:l,postPrivacy:c,isDraft:!!m||""}).done(function(t){var e=c!==r||f&&!m,i=s.children(".content").first();if(l&&i.addClass("content-warning-post"),e){var o=m?'<i class="fa fa-pencil-ruler"></i>':"public"==c?'<i class="fas fa-eye"></i>':'<i class="fas fa-eye-slash"></i>';s.find(".post-visibility").html(o)}f&&!m?(s.find(".metadata").find(".post-edited").remove(),s.find(".toolbar").remove()):(postHasEditedTag=!!s.find(".metadata").find(".post-edited").length,postHasEditedTag||f&&!m||s.find(".metadata").append('&nbsp;&middot;&nbsp;<span class="post-edited">Edited</span>')),i.html(t);var a=i.find(".post-images a");a.length&&a.simpleLightbox(),$("body").on("hidden.bs.modal","#editPostModal",function(t){t.target.remove(),$("body").off("hidden.bs.modal")}),$("#editPostModal").modal("hide");var n=s.offset().top,d=n+s.outerHeight(),p=d-n,h=$(window).scrollTop(),u=$(window).height(),v=h+u;h+75>n?$("html").animate({scrollTop:Math.max(0,n-100)}):d>v&&p<u&&$("html").animate({scrollTop:h+(d-v)+10})}).fail(function(){bootbox.alert("this edit operation failed somehow, sorry... maybe wait a few seconds and try again"),e.attr("disabled",!1),e.html('Try again... <i class="fas fa-chevron-right"></i>')})}else bootbox.alert("If you want to delete your post there is a... much better way to do that")}),$("body").on("click",".reply-to-comment",function(){var t=$(this).closest(".comment"),e=t.closest(".post").attr("data-post-id"),i=t.attr("data-comment-id"),o=t.find('.new-comment-form[data-comment-id="'+i+'"]');if(o.length)return o[0].getBoundingClientRect().bottom>$(window).height()-50&&$("html, body").animate({scrollTop:o.offset().top-200},200),void console.log("Form already exists!");var a=$(document.getElementById("new-comment-form-template").innerHTML);a.attr("data-comment-type","child").attr("data-post-id",e).attr("data-comment-id",i),a.appendTo(t),attachQuill(a.find(".editable-text")[0],"Reply to this post with a good reply"),tribute.attach(a.find(".ql-editor")),a[0].getBoundingClientRect().bottom>$(window).height()-50&&$("html, body").animate({scrollTop:a.offset().top-200},200)})}),$(function(){$("body").on("click","#postImageButton",function(t){let e=$(this).closest(".contentForm, .new-comment-form").children(".file-input");var i=$(this).closest(".contentForm, .new-comment-form").find(".ql-container")[0];i.imagesAdded()<4?(e[0].changeEventAttached||(e.change(function(t){for(var e=0;e<this.files.length;e++){if(i.imagesAdded()>3){bootbox.alert("we only take 4 images at a time right now, sorry");break}i.addImage(this.files[e])}$(this).val("")}),e[0].changeEventAttached=!0),e.click()):bootbox.alert("we only take 4 images at a time right now, sorry")}),$("body").on("click","#postLinkButton",function(t){var e=$(this).closest(".contentForm, .new-comment-form").children(".link-form-cont");e.is(":hidden")?e.slideDown("fast",function(){e.find("input").focus()}):e.slideUp("fast")}),$("body").on("click",".link-add",function(t){var e=$(this).siblings("input"),i=e.val();i||(i=e.attr("placeholder")),e.val("");var o=$(this).closest(".contentForm, .new-comment-form").find(".ql-container")[0];o.linkPreviewsAdded()<4?o.addLinkPreview(i):bootbox.alert("we only take 4 link previews per post, sorry")}),$("body").on("keyup","#linkPreviewUrlEntry",function(t){13==t.keyCode&&$(this).siblings(".link-add").click()}),$("body").on("click","#postSubmit",function(t){t.preventDefault(),$("#editPostModal").remove();let e=$(this).closest(".contentForm"),i=e.find("#editor"),o=i[0].getContents();if(i[0].hasContent()){var a=$(this);a.attr("disabled",!0),$.ajax({url:"/createpost",type:"POST",data:{communityId:e.attr("communityId"),isDraft:!!e.find("#pseudoPrivacy-draft").is(":checked")||"",postPrivacy:e.find("#postPrivacy-public").is(":checked")?"public":"private",postContent:JSON.stringify(o),postContentWarnings:e.find("#postContentWarnings").val()}}).done(function(t){e.find("#postContentWarnings").val(""),e.find("#postContentWarningsContainer").slideUp("fast"),e.find("#new-post-emoji-picker").slideUp("fast"),e.find(".link-form-cont").slideUp("fast");var o=i.find(".ql-editor");o.html(""),a.attr("disabled",!1),e.find("#pseudoPrivacy-draft").is(":checked")&&"/drafts/"!=activeScrollPath?(o.attr("data-placeholder","Post saved to drafts; view those through your profile."),o.focus(function(){o.attr("data-placeholder",i[0].__quill.options.placeholder),o.off("focus")})):(e.find("#pseudoPrivacy-draft").is(":checked")||"/drafts/"!=activeScrollPath||$active("#toggle-drafts-mode").click(),restartInfiniteScroll(t))}).fail(function(){bootbox.alert("this post failed to post! maybe try again in a bit?"),a.attr("disabled",!1)})}else bootbox.alert("This post appears to be... empty")}),$("body").on("click",".create-comment",function(){let t=$(this),e=t.closest(".new-comment-form"),i=e.attr("data-comment-type"),o=e.attr("data-post-id"),a=e.attr("data-comment-id"),n=e.find(".ql-container"),s=e.find(".ql-editor"),d=n[0].getContents();"primary"==i?commentsContainer=t.closest(".comments").find(".comments-container"):"child"==i&&(commentsContainer=t.closest(".comments-container").find(".comment[data-comment-id="+a+"]").find(".replies")[0]);let l=e.find(".emoji-picker");n[0].hasContent()&&(t.prop("disabled",!0),$.post("/createcomment/"+o+"/"+a,{commentContent:JSON.stringify(d)},function(o){if("nope"!=o){s.html("");var a=$(o.comment).hide().appendTo(commentsContainer).fadeIn(),n=a.offset().top,d=n+a.outerHeight();(n-100<$(window).scrollTop()||d>$(window).scrollTop()+$(window).height())&&$("html").animate({scrollTop:Math.max(0,n-100)});var r=a.find(".post-images a");r.length&&r.simpleLightbox();let c=t.closest(".post").find(".show-comments").find(".comments-number")[0];if(""===c.textContent)c.innerHTML="1";else{let t=parseInt(c.textContent)+1;c.innerHTML=c.innerHTML.replace(t-1,t)}"primary"==i?(t.prop("disabled",!1),l.hide()):"child"==i&&e.remove()}else{let t='<article class="comment"><div class="message alert">There has been a problem posting your comment. Sorry! Please copy the comment text, refresh the page, and try again.</div></article>';$(t).hide().appendTo(commentsContainer).fadeIn()}}))})});