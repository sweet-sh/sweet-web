function updateSubmitButtonState(e){var t=e.find(".create-comment, #postSubmit");if(0==e.find(".still-loading").length){t=e.find(".create-comment, #postSubmit");t.attr("disabled",!1),t.hasClass("save-draft-button")?t.html('Save <i class="fas fa-chevron-right"></i>'):t.hasClass("create-comment")?t.html('Reply <i class="fas fa-chevron-right"></i>'):"postSubmit"==t.attr("id")&&t.html('Send <i class="fas fa-chevron-right"></i>')}else t.attr("disabled",!0),t.html("<i class='fas fa-spinner fa-spin'></i> Uploading")}function clearEmbed(e){e.preventDefault();var t=$(this).closest(".slidable-embed");!t.hasClass("image-preview-container")||t.attr("imagealreadysaved")||t.hasClass("still-loading")||$.post("/cleartempimage",{imageURL:t.attr("image-url")});var i=t.closest(".ql-container")[0].__quill;i.updateContents(),i.focus(),t[0].request&&4!=t[0].request.readyState&&t[0].request.abort();var o=t.closest(".new-comment-form, .contentForm");t.remove(),updateSubmitButtonState(o),createImageGroups(o.find(".ql-editor"))}function attachQuill(e,t,i){var o=new Quill(e,{formats:["bold","italic","list","link","blockquote","PostImage","LinkPreview"],modules:{toolbar:["bold","italic",{list:"bullet"},"link","blockquote"],keyboard:{bindings:{"list autofill":{key:32,handler:function(){return!0}},blqtBksp:{key:"backspace",collapsed:!0,format:["blockquote"],offset:0,handler:function(e,t){this.quill.format("blockquote",!1)}},embedBksp:{key:"backspace",collapsed:!0,offset:0,handler:function(e,t){if("\n"==this.quill.getText(e.index,1)){var i=this.quill.getContents(e.index-1,1);if(i.ops.length&&i.ops[0].insert&&(i.ops[0].insert.LinkPreview||i.ops[0].insert.PostImage))return this.quill.deleteText(e.index,1),!1}return!0}}}}},placeholder:t||"Write something, highlight text to format.",theme:"bubble"});o.clipboard.addMatcher(Node.ELEMENT_NODE,function(e,t){for(var i=0;i<t.ops.length;i++)"string"!=typeof t.ops[i].insert&&(t.ops[i].insert="");return t}),o.clipboard.addMatcher("ol",function(e,t){for(var i=0;i<t.ops.length;i++)t.ops[i].attributes&&t.ops[i].attributes.list&&"ordered"==t.ops[i].attributes.list&&delete t.ops[0].attributes.list;return t});var n=new MutationObserver(function(t){for(var i="<div class='link-preview-prompt'><div class='link-preview-prompt-text'>Click to add link preview</div><div class='link-preview-prompt-dismiss'><i class='fa fa-times'></i></div></div>",n=0;n<t.length;n++)if("childList"==t[n].type&&"P"==t[n].target.nodeName&&1==t[n].addedNodes.length&&t[n].addedNodes[0].nodeType==Node.TEXT_NODE){var r=t[n].addedNodes[0].nodeValue,a=t[n].addedNodes[0],s=t[n].target;if(youtubeUrlFindingRegex.test(r)||vimeoUrlFindingRegex.test(r)){$(".link-preview-prompt").remove();var l=$(i);$(e).append(l),l.css("left",s.offsetLeft+"px").css("top",s.offsetTop+s.offsetHeight+"px");var d=new MutationObserver(function(){s.parentNode&&s.parentNode.contains(s)?l.css("left",s.offsetLeft+"px").css("top",s.offsetTop+s.offsetHeight+"px"):(l.remove(),this.disconnect())});console.log("watching parent node ",s.parentNode),d.observe(s.parentNode,{childList:!0});var c=new MutationObserver(function(){s&&s.innerText&&0==s.innerText.indexOf(r)||(l.remove(),this.disconnect(),d.disconnect())});c.observe(s,{subtree:!0,characterData:!0}),l.click(function(t){console.log(t),c.disconnect(),d.disconnect();var i=o.getText().indexOf(r);-1!=i&&(i+=$(s).prevAll(".slidable-embed").length,a.nodeValue=a.nodeValue.replace(r,""),""==s.innerHTML&&s.parentElement.removeChild(s),e.addLinkPreview(r,i),o.setSelection(i+1)),l.remove()}),l.find(".link-preview-prompt-dismiss").click(function(){l.remove(),c.disconnect(),d.disconnect()})}}});n.observe(e,{subtree:!0,childList:!0}),o.on("selection-change",function(t,i,o){t||(e.lastCursorPos=i.index)}),e.insertEmojiAtCursor=function(t){var i=void 0;(i=o.getSelection())?(i.length>0&&o.deleteText(i.index,i.length),o.insertText(i.index,t)):e.lastCursorPos?o.insertText(e.lastCursorPos,t):(o.insertText(0,t),o.focus(),o.setSelection(t.length,0))},e.hasContent=function(){return o.getText().trim().length>0||o.getLength()>o.getText().length},e.getContents=function(){if(e.imagesAdded()>0||e.linkPreviewsAdded()>0){var t=$(e).children(".ql-editor").children(),i=[];return t.each(function(e,t){t=$(t);if(!(t.hasClass("still-loading")||t.hasClass("onthemove")||t.hasClass("embedspacer")||"loading..."==t.attr("image-url")))if(t.hasClass("link-preview-container"))i.push({type:"link-preview",linkUrl:t.attr("linkUrl")});else if(t.hasClass("image-preview-container")){var o=i[i.length-1];o&&"string"!=typeof o&&"image(s)"==o.type?(o.imageDescriptions.push(t.find("#postImageDescription").val()),o.images.push(t.attr("image-url"))):i.push({type:"image(s)",imageDescriptions:[t.find("#postImageDescription").val()],images:[t.attr("image-url")]})}else i.push(t[0].outerHTML)}),i}return $(e).children(".ql-editor").html()},e.getQuill=function(){return o},i||(o.on("text-change",function(e,t,i){""===o.getText()&&o.insertText(o.getLength(),"\n")}),e.addLinkPreview=function(t,i){if(void 0===i){var n=o.getSelection(!0),r=n.index;if(0==n.length&&"\n"==o.getText(r,1)&&""!=o.getText(r+1,1)){o.deleteText(r,1);var a=r}else a=o.getLength()}else a=i;o.insertEmbed(a,"LinkPreview",t,Quill.sources.USER),updateSubmitButtonState($(e).closest(".contentForm, .new-comment-form"))},e.addImage=function(t){var i=o.getSelection(!0),n=i?i.index:0;if(0==i.length&&"\n"==o.getText(n,1)&&""!=o.getText(n+1,1)){o.deleteText(n,1);var r=n}else r=o.getLength();try{o.insertEmbed(r,"PostImage",t,Quill.sources.USER)}catch(e){console.log("image type/size unsupported!"),console.log(e)}updateSubmitButtonState($(e).closest(".contentForm, .new-comment-form")),createImageGroups($(e).children(".ql-editor"))},e.imagesAdded=function(){return $(e).children(".ql-editor").children(".image-preview-container").length},e.linkPreviewsAdded=function(){return $(e).children(".ql-editor").children(".link-preview-container").length},e.onclick=function(e){var t=$(e.target);if(t.hasClass("ql-editor")){var i=t.children(),n=i.first(),r=i.last();if(n.hasClass("slidable-embed")&&e.clientY<getTop(n))o.insertText(0,"\n"),o.setSelection(0);else if(r.hasClass("slidable-embed")&&e.clientY>getTop(r)+r.outerHeight(!1))o.insertText(o.getLength(),"\n"),o.setSelection(o.getLength());else{var a=void 0,s=!1;t.children().each(function(i,o){if(!s){if(o=$(o),a&&o.hasClass("slidable-embed")&&a.hasClass("slidable-embed")&&e.clientY<getTop(o)&&e.clientY>getTop(a)+a.outerHeight(!1)){var n=$("<p></p>");a.after(n);var r=window.getSelection(),l=document.createRange();l.setStart(n[0],0),l.collapse(!0),r.removeAllRanges(),r.addRange(l),s=!0,createImageGroups(t)}a=o}})}}},e.onpaste=function(t){for(var i=(event.clipboardData||event.originalEvent.clipboardData).items,o=0;o<i.length;o++)if(0===i[o].type.indexOf("image")){if(e.imagesAdded()>3){bootbox.alert("sorry, we only take 4 images at once atm");break}t.preventDefault(),e.addImage(i[o].getAsFile())}},e.ondrop=function(t){if(t.preventDefault(),$(".post-controls").css("display","flex"),t.dataTransfer.items)for(var i=0;i<t.dataTransfer.items.length;i++){if(e.imagesAdded()>3){bootbox.alert("sorry, we only take 4 images at once atm");break}"file"===t.dataTransfer.items[i].kind&&0===t.dataTransfer.items[i].type.indexOf("image")&&e.addImage(t.dataTransfer.items[i].getAsFile())}else for(i=0;i<t.dataTransfer.files.length;i++){if(e.imagesAdded()>3){bootbox.alert("sorry, we only take 4 images at once atm");break}0===t.dataTransfer.files[i].type.indexOf("image")&&e.addImage(t.dataTransfer.files[i])}removeBodyFader(t)},dragFaderActivated||($(function(){document.body.ondragover=function(e){e.preventDefault();var t=e.dataTransfer;t.types&&(t.types.indexOf?-1!=t.types.indexOf("Files"):t.types.contains("Files"))&&(faded||($("body").append('<div id="bodyFader"></div>'),$("#bodyFader").fadeIn(100),faded=!0))},document.body.ondragend=removeBodyFader,document.body.ondrop=removeBodyFader,window.ondragenter=function(e){e.preventDefault(),dragcounter++},window.ondragleave=function(e){dragcounter--,dragcounter<1&&removeBodyFader(e)}}),dragFaderActivated=!0))}function removeBodyFader(e){e.preventDefault(),$("#bodyFader").fadeOut(100,function(){$("#bodyFader").remove(),dragcounter=0,faded=!1})}function mousedownOnHandle(e){e.preventDefault(),$(this).addClass("in-use");var t=$(this).parent().parent(),i=prepareEmbedForMoving(t);i[0].pointerOffset=e.originalEvent.clientY-getTop(i),prevPointerY=e.originalEvent.clientY,$(document).mousemove(function(e){return e.preventDefault(),moveEmbed(e.originalEvent.clientY,i,t),!1}),$(document).on("mouseup",function(e){endMovement(),$(document).off("mousemove"),$(document).off("mouseup")})}function touchStartOnHandle(e){function t(e){e.cancelable&&e.preventDefault(),moveEmbed(e.changedTouches[0].clientY,o,i)}if(e.cancelable&&e.preventDefault(),!touchinprogress){touchinprogress=!0;var i=$(this).parent().parent(),o=prepareEmbedForMoving(i);o[0].pointerOffset=e.changedTouches[0].clientY-getTop(o),prevPointerY=e.changedTouches[0].clientY,this.addEventListener("touchmove",t,{passive:!1}),this.addEventListener("touchend",function(e){touchinprogress=!1,this.removeEventListener("touchmove",t),endMovement()}),this.addEventListener("touchcancel",function(e){touchinprogress=!1,this.removeEventListener("touchmove",t),endMovement()})}}function getTop(e){return e.offset().top-$(window).scrollTop()}function prepareEmbedForMoving(e){var t=e,i=e.clone(!1);return i.find(".image-move")[0].addEventListener("touchstart",touchStartOnHandle,{passive:!1}),i.find(".image-move").on("mousedown",mousedownOnHandle),i.find(".image-clear").click(clearEmbed),i.css("width",t.outerWidth(!0)+"px"),i.css("left",t.offset().left+"px"),i.css("top",getTop(t)+"px"),e.hasClass("ipc-group")&&createImageGroups(e.parent()),t.addClass("embedspacer"),t.attr("id",""),t.removeClass("ipc-group ipc-group-top ipc-group-bottom"),$("body").append(i),i.css("position","fixed"),i.css("z-index",2147483647),i.removeClass("ipc-group ipc-group-top ipc-group-bottom"),i.addClass("onthemove"),t.empty(),i[0].scrollPrompterId=setInterval(function(){scrollPrompter(i,t.closest(".ql-editor"))},50),lastWindowPos=window.scrollY,$(window).on("scroll",function(e){window.scrollY>lastWindowPos?moveEmbed(prevPointerY,i,t,"down"):window.scrollY<lastWindowPos&&moveEmbed(prevPointerY,i,t,"up"),lastWindowPos=window.scrollY}),i}function scrollPrompter(e,t){var i=getTop(e),o=e.outerHeight(),n=i+o,r=getTop(t),a=r+t.outerHeight(),s=t.closest(".modal"),l=$(window),d=l.scrollTop(),c=l.height();i<100&&r<50?s.length?s.scrollTop(s.scrollTop()-10):l.scrollTop(d-10):n>c-100&&a>c&&(s.length?s.scrollTop(s.scrollTop()+10):l.scrollTop(d+10))}function moveEmbed(e,t,i,o){var n=e-prevPointerY;prevPointerY=e;var r=getTop(t),a=(getTop(i),t.outerHeight(!0)),s=Math.min(Math.max(e-t[0].pointerOffset,getTop(i.parent())),getTop(i.parent())+(i.parent().outerHeight(!0)-i.outerHeight(!0)));if(t.css("top",s+"px"),"down"==o||n>0){for(var l=i.next();l.length&&l.next().length&&r+a>getTop(l)+l.outerHeight(!0);)l=l.next();if(l.length){var d=getTop(l),c=Math.max(d+.5*l.outerHeight(!0),d+l.outerHeight(!0)-70);r+a>c&&i.insertAfter(l)}}else if("up"==o||n<0){for(var m=i.prev();m.length&&m.prev().length&&r<getTop(m);)m=m.prev();if(m.length){c=Math.min(getTop(m)+.5*m.outerHeight(!0),getTop(m)+70);r<c&&i.insertBefore(m)}}createImageGroups(i.parent())}function endMovement(){var e=$(".onthemove");if(e.length){clearInterval(e[0].scrollPrompterId),$(window).off("scroll"),$(".embedspacer").after($(".onthemove")),e.css("position","").css("border","").css("width","").css("left","").css("top","").css("height","").css("z-index",10),e.removeClass("onthemove"),e.find(".image-move").removeClass("in-use");var t=$(".embedspacer");t.remove(),createImageGroups(e.closest(".ql-editor"))}}function createImageGroups(e){for(var t=e.children(),i=0,o=0;o<t.length;o++){var n=$(t[o]);n.hasClass("image-preview-container")&&!n.hasClass("embedspacer")?(i++,i>1&&(2==i?$(t[o-1]).addClass("ipc-group ipc-group-top").removeClass("ipc-group-bottom"):$(t[o-1]).addClass("ipc-group").removeClass("ipc-group-top ipc-group-bottom"))):(i>1?$(t[o-1]).addClass("ipc-group ipc-group-bottom").removeClass("ipc-group-top"):1==i&&$(t[o-1]).removeClass("ipc-group ipc-group-top ipc-group-bottom"),i=0)}i>1?$(t[t.length-1]).addClass("ipc-group ipc-group-bottom").removeClass("ipc-group-top"):1==i&&$(t[t.length-1]).removeClass("ipc-group ipc-group-top ipc-group-bottom")}var newEmbedId=0;let BlockEmbed=Quill.import("blots/block/embed");var youtubeUrlFindingRegex=/^((?:https?:)?\/\/)?((?:www|m)\.)?((?:youtube\.com|youtu.be))(\/(?:[\w\-]+\?v=|embed\/|v\/)?)([\w\-]+)(\S+)?$/,vimeoUrlFindingRegex=/^(http|https)?:\/\/(www\.)?vimeo.com\/(?:channels\/(?:\w+\/)?|groups\/([^\/]*)\/videos\/|)(\d+)(?:|\/\?)$/;class LinkPreview extends BlockEmbed{static create(e){var t=youtubeUrlFindingRegex.test(e)||vimeoUrlFindingRegex.test(e);let i=super.create();i.setAttribute("id","embed"+newEmbedId),i.setAttribute("linkUrl",e);var o=newEmbedId;newEmbedId++,i.setAttribute("data-url",e),i.setAttribute("contenteditable",!1),i.innerHTML=$("#new-post-link-preview-contents")[0].innerHTML;var n=$(i);return n.addClass("still-loading"),n.addClass("slidable-embed"),n.find(".link-preview-image").on("error",function(e){$(this).replaceWith('<div class="link-preview-image""><i class="fas fa-link"></i></div>')}),i.request=$.post("/api/newpostform/linkpreviewdata",{url:e},function(n,r,a){var s=$("#embed"+o);if(s.length)if(s.removeClass("still-loading"),"invalid url i guess"==n)bootbox.alert("Sorry, we couldn't connnect to that url ("+e+") to obtain a preview :("),endMovement(),s.find(".image-clear").click();else{var l=JSON.parse(n);console.log(JSON.stringify(l,null,4)),i.setAttribute("href",l.linkUrl),l.image?s.find(".link-preview-image").replaceWith('<img class="link-preview-image" src="'+l.image+'" />'):s.find(".link-preview-image").replaceWith('<div class="link-preview-image"><i class="fas fa-link"></i></div>'),s.find(".link-preview-title").html(l.title),s.find(".link-preview-description").html(l.description),s.find(".link-preview-domain").html(l.domain+(t?" (will open as embed)":"")),updateSubmitButtonState(s.closest(".new-comment-form, .contentForm"))}}),i.request.fail(function(t,i,n){var r=$("#embed"+o);r.length&&(r.removeClass("still-loading"),bootbox.alert("Sorry, we couldn't connect to that url ("+e+") to obtain a preview :("),endMovement(),r.find(".image-clear").click(),"abort"!=n&&$.post("/admin/reporterror",{errorstring:"error creating link preview for url "+e+":\n"+n}))}),n.find(".image-clear").click(clearEmbed),n.find(".image-move").on("mousedown",mousedownOnHandle),n.find(".image-move")[0].addEventListener("touchstart",touchStartOnHandle,{passive:!1}),i}static value(e){return e.getAttribute("data-url")}static formats(e){var t=$(e);return t.hasClass("still-loading")||t.hasClass("onthemove")||t.hasClass("embedspacer")?{}:{title:t.find(".link-preview-title").html(),description:t.find(".link-preview-description").html(),domain:t.find(".link-preview-domain").html().replace(" (will open as embed)",""),image:t.find(".link-preview-image").attr("src")}}}LinkPreview.blotName="LinkPreview",LinkPreview.tagName="a",LinkPreview.className="link-preview-container",Quill.register(LinkPreview);var files={};class PostImage extends BlockEmbed{static create(e){if("string"==typeof e){var t=e;let o=super.create();o.setAttribute("contenteditable",!1),o.setAttribute("imagealreadysaved","true"),o.setAttribute("fullsavedurl",t),o.innerHTML=$("#new-post-image-preview-contents")[0].innerHTML,o.setAttribute("id","embed"+newEmbedId),newEmbedId++;var i=$(o);return i.addClass("slidable-embed"),i.find(".fader").remove(),i.find(".image-preview").css("background-image","url("+t+")"),i.find(".image-clear").click(clearEmbed),i.find(".image-move").on("mousedown",mousedownOnHandle),i.find(".image-move")[0].addEventListener("touchstart",touchStartOnHandle,{passive:!1}),o}var o=e;if("image/jpeg"!=o.type&&"image/png"!=o.type&&"image/gif"!=o.type)throw bootbox.alert("Sorry, but this appears to be an unsupported file type! We only take JPG, PNG, and GIF images at the moment"),(o.name?o.name:"")+" of unsupported mime type";if(!(("image/jpeg"===o.type||"image/png"===o.type)&&o.size<10485760||"image/gif"===o.type&&o.size<5242880))throw bootbox.alert("Sorry, but this file appears to be too large! The maximum size for GIF images is 5MB and for JPG and PNG images is 10MB."),(o.name?o.name:"")+" too large";let n=super.create();n.setAttribute("id","embed"+newEmbedId),files[n.getAttribute("id")]=o;var r=newEmbedId;newEmbedId++,n.setAttribute("contenteditable",!1),n.setAttribute("image-url","loading..."),n.innerHTML=$("#new-post-image-preview-contents")[0].innerHTML;i=$(n);i.addClass("still-loading"),i.addClass("slidable-embed");var a=URL.createObjectURL(o);i.find(".image-preview")[0].style.backgroundImage="url("+a+")";var s=new FormData;return s.append("image",o),n.request=$.ajax({xhr:function(){var e=new XMLHttpRequest;return e.upload.addEventListener("progress",function(e){var t=Math.round(e.loaded/e.total*100),i=$("#embed"+r);i.find("progress").attr("value",t),i.find("#percentage").html(100==t?t+"%!!!":t+"%")}),e},url:"/api/image/v2",type:"POST",data:s,processData:!1,contentType:!1,error:function(e,t,i){var o=$("#embed"+r);o.find("progress").attr("value",0),o.find("#percentage").html("Upload error :( Hit the X and try again?"),console.log("image upload error: "+i),o.removeClass("still-loading"),updateSubmitButtonState(o.closest(".new-comment-form, .contentForm")),"abort"!=i&&$.post("/admin/reporterror",{errorstring:"error uploading image:\n"+i})},success:function(e,t,i){var n=$("#embed"+r);n.removeClass("still-loading");var a=JSON.parse(e);a.error?("filesize"==a.error?bootbox.alert("Image too large! The maximum size for GIF images is 5MB and for JPG and PNG images is 10MB."):"filetype"==a.error&&bootbox.alert("We cannot use this fileOrUrl! Please make sure you are uploading a JPG, PNG, or GIF from this universe."),endMovement(),n.find(".image-clear").click()):(a.thumbnail&&fetch(a.thumbnail).then(e=>e.blob()).then(e=>{n.find(".image-preview").css("background-image","url("+URL.createObjectURL(e)+")")}),n.find(".fader").remove(),n.attr("image-url",a.url),updateSubmitButtonState(n.closest(".new-comment-form, .contentForm")),setTimeout(function(){var e=$("#embed"+r);if(e.length){$(".bootbox-alert.show").length||bootbox.alert("hey your images are expired and stuff whoops sorry! this tab has apparently been open for a week. or maybe linear time has ceased to function. i guess you can reupload? you probably weren't going to finish this post anyway? geez");var t=e.find("#postImageDescription").val();t.trim()?e.replaceWith("<p>Image: "+t.trim()+(o.name?" ("+o.name+")":"")+"</p>"):o.name?"image.png"!=o.name?e.replaceWith("<p>Image: "+o.name+"</p>"):e.replaceWith("<p>Pasted image</p>"):e.replaceWith("<p>Image</p>"),createImageGroups(e.parent())}},6048e5))}}),i.find(".image-clear").click(clearEmbed),i.find(".image-move").on("mousedown",mousedownOnHandle),i.find(".image-move")[0].addEventListener("touchstart",touchStartOnHandle,{passive:!1}),n}static value(e){return e.getAttribute("imagealreadysaved")?e.getAttribute("fullsavedurl"):files[e.getAttribute("id")]}static formats(e){return{description:$(e).find("#postImageDescription").val(),imageURL:e.getAttribute("image-url")}}format(e,t){"description"==e?$(this.domNode).find("#postImageDescription").val(t):"imageURL"==e&&this.domNode.setAttribute("image-url",t)}}PostImage.blotName="PostImage",PostImage.tagName="div",PostImage.className="image-preview-container",Quill.register(PostImage);var dragcounter=0,faded=!1;dragFaderActivated=!1;var touchinprogress=!1;window.addEventListener("beforeunload",function(e){var t=!1;if($active(".ql-container:not(.form-control)").each(function(e,i){!t&&i.hasContent()&&(t=!0)}),t)return e.preventDefault(),e.stopPropagation(),e.returnValue="there is content in the post box, would you like to perhaps save it as draft first","there is content in the post box, would you like to perhaps save it as draft first"}),window.addEventListener("unload",function(e){$("div.image-preview-container:not(.still-loading)").each(function(e,t){t.getAttribute("imagealreadysaved")||$.post("/cleartempimage",{imageURL:t.getAttribute("image-url")})})}),$("body").on("click",".ql-editor .link-preview-container",function(e){e.preventDefault()});